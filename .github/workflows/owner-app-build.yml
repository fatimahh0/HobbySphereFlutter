name: Owner App Build (Android APK)

on:
  repository_dispatch:
    types: [owner_app_build]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    # Map payload + secrets to env so we can use env.* inside `if:`
    env:
      # ---- payload (≤10 props; RUNTIME is nested) ----
      OWNER_ID:               ${{ github.event.client_payload.OWNER_ID }}
      PROJECT_ID:             ${{ github.event.client_payload.PROJECT_ID }}
      OWNER_PROJECT_LINK_ID:  ${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}
      SLUG:                   ${{ github.event.client_payload.SLUG }}
      APP_NAME:               ${{ github.event.client_payload.APP_NAME }}
      THEME_ID:               ${{ github.event.client_payload.THEME_ID }}
      APP_LOGO_URL:           ${{ github.event.client_payload.APP_LOGO_URL }}
      API_BASE_URL:           ${{ github.event.client_payload.RUNTIME.API_BASE_URL }}
      WS_PATH:                ${{ github.event.client_payload.RUNTIME.WS_PATH }}
      APP_ROLE:               ${{ github.event.client_payload.RUNTIME.APP_ROLE }}
      OWNER_ATTACH_MODE:      ${{ github.event.client_payload.RUNTIME.OWNER_ATTACH_MODE }}

      # ---- secrets mirrored to env (so we can test in `if:`) ----
      SSH_HOST:               ${{ secrets.SSH_HOST }}
      SSH_USER:               ${{ secrets.SSH_USER }}
      SSH_KEY:                ${{ secrets.SSH_KEY }}
      APK_ROOT:               ${{ secrets.APK_ROOT }}
      BACKEND_BASE_URL:       ${{ secrets.BACKEND_BASE_URL }}
      CI_CALLBACK_TOKEN:      ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: '34.0.0'

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter doctor & deps
        run: |
          flutter doctor -v
          flutter pub get
          test -f pubspec.yaml || (echo "Missing pubspec.yaml" && exit 1)
          test -f lib/app/main_activity.dart || (echo "Missing lib/app/main_activity.dart" && exit 1)

      - name: Ensure tools + dirs
        run: |
          sudo apt-get update
          sudo apt-get install -y jq openssh-client
          mkdir -p assets/icons assets/splash

      - name: Prepare logo (download public URL)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${APP_LOGO_URL:-}" ]; then
            echo "APP_LOGO_URL is empty. Using a 1x1 placeholder."
            printf '\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\0\x01\0\0\0\x01\x08\x06\0\0\0\x1f\x15\xc4\x89\0\0\0\x0cIDATx\x9cc```\0\0\0\x04\0\x01\r\n-\xb4\0\0\0\0IEND\xaeB`\x82' > assets/icons/app_icon.png
          else
            curl -fsSL "$APP_LOGO_URL" -o assets/icons/app_icon.png
          fi
          cp assets/icons/app_icon.png assets/splash/splash.png
          dart run flutter_launcher_icons
          dart run flutter_native_splash:create

      - name: Build APK (release)
        run: |
          set -e
          flutter build apk --release \
            -t lib/app/main_activity.dart \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=OWNER_PROJECT_LINK_ID="$OWNER_PROJECT_LINK_ID" \
            --dart-define=OWNER_ATTACH_MODE="$OWNER_ATTACH_MODE" \
            --dart-define=APP_ROLE="$APP_ROLE" \
            --dart-define=WS_PATH="$WS_PATH" \
            --dart-define=PROJECT_ID="$PROJECT_ID" \
            --dart-define=APP_NAME="$APP_NAME" \
            --dart-define=APP_LOGO_URL="$APP_LOGO_URL" \
            --dart-define=SLUG="$SLUG" \
            --dart-define=THEME_ID="$THEME_ID"

      - name: List outputs
        run: ls -R build/app/outputs/flutter-apk || true

      - name: Upload artifact (manual download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SLUG }}-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
          retention-days: 14

      - name: Create GitHub Release (optional public link)
        id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-${{ env.SLUG }}-${{ github.run_id }}
          name: "${{ env.APP_NAME }} (run ${{ github.run_id }})"
          files: build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract first APK URL from release
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: app-${{ env.SLUG }}-${{ github.run_id }}
        run: |
          set -euo pipefail
          json="$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")"
          urls="$(echo "$json" | jq -e -r '.assets[]? | select(.name|test("\\.apk$")) | .browser_download_url')"
          first_url="$(echo "$urls" | head -n 1 || true)"
          echo "apk_url=$first_url" >> "$GITHUB_OUTPUT"
          echo "Resolved Release APK: $first_url"

      # ---------- OPTIONAL: Copy APK to your backend server (SCP) ----------
      - name: Copy APK to server via SCP (optional)
        if: ${{ env.SSH_HOST != '' && env.SSH_USER != '' && env.SSH_KEY != '' && env.APK_ROOT != '' }}
        run: |
          set -euo pipefail
          apk_file="$(ls -1 build/app/outputs/flutter-apk/*.apk | head -n1)"
          [ -n "$apk_file" ] || { echo "No APK found"; exit 1; }
          dest_dir="${APK_ROOT}/${OWNER_ID}/${PROJECT_ID}/${SLUG}"
          dest_file="${SLUG}-${GITHUB_RUN_ID}.apk"
          umask 077
          echo "$SSH_KEY" > id_rsa
          chmod 600 id_rsa
          ssh -i id_rsa -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" "mkdir -p '$dest_dir'"
          scp -i id_rsa -o StrictHostKeyChecking=no "$apk_file" "$SSH_USER@$SSH_HOST:$dest_dir/$dest_file"
          echo "apk_rel=/uploads/apk/${OWNER_ID}/${PROJECT_ID}/${SLUG}/${dest_file}" >> $GITHUB_ENV
          echo "Saved on server as: $dest_dir/$dest_file"

      # ---------- OPTIONAL: Callback your backend to save apkUrl ----------
      - name: Callback backend with apkUrl (optional)
        if: ${{ env.BACKEND_BASE_URL != '' && env.CI_CALLBACK_TOKEN != '' }}
        run: |
          set -euo pipefail
          apk_url="${apk_rel:-${{ steps.extract.outputs.apk_url }}}"
          if [ -z "$apk_url" ]; then
            echo "No APK URL available for callback; skipping."
            exit 0
          fi
          if echo "$OWNER_PROJECT_LINK_ID" | grep -Eq '^[0-9]+$'; then
            echo "Calling linkId callback..."
            curl -fsS -X PUT \
              -H "Content-Type: application/json" \
              -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
              -d "{\"apkUrl\":\"${apk_url}\"}" \
              "${BACKEND_BASE_URL}/api/ci/owner-project-links/${OWNER_PROJECT_LINK_ID}/apk-url"
          else
            echo "Calling slug callback..."
            curl -fsS -X PUT \
              -H "Content-Type: application/json" \
              -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
              -d "{\"apkUrl\":\"${apk_url}\"}" \
              "${BACKEND_BASE_URL}/api/ci/owner-projects/${OWNER_ID}/${PROJECT_ID}/apps/${SLUG}/apk-url"
          fi
          echo "Backend updated with apkUrl ✅"
