name: Owner App Build (Android APK)

on:
  repository_dispatch:
    types: [owner_app_build]
  workflow_dispatch: {}

permissions:
  contents: write   # needed to commit/push the manifest

jobs:
  build-android:
    runs-on: ubuntu-latest

    # Map payload + secrets to env so we can use env.* inside steps
    env:
      # ---- payload (â‰¤10 top-level props; RUNTIME is nested) ----
      OWNER_ID:               ${{ github.event.client_payload.OWNER_ID }}
      PROJECT_ID:             ${{ github.event.client_payload.PROJECT_ID }}
      OWNER_PROJECT_LINK_ID:  ${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}
      SLUG:                   ${{ github.event.client_payload.SLUG }}
      APP_NAME:               ${{ github.event.client_payload.APP_NAME }}
      THEME_ID:               ${{ github.event.client_payload.THEME_ID }}
      APP_LOGO_URL:           ${{ github.event.client_payload.APP_LOGO_URL }}
      API_BASE_URL:           ${{ github.event.client_payload.RUNTIME.API_BASE_URL }}
      WS_PATH:                ${{ github.event.client_payload.RUNTIME.WS_PATH }}
      APP_ROLE:               ${{ github.event.client_payload.RUNTIME.APP_ROLE }}
      OWNER_ATTACH_MODE:      ${{ github.event.client_payload.RUNTIME.OWNER_ATTACH_MODE }}

      # ---- (No server/SSH/callback in pull model) ----
      # BACKEND_BASE_URL:
      # CI_CALLBACK_TOKEN:
      # SSH_HOST:
      # SSH_USER:
      # SSH_KEY:
      # APK_ROOT:

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: '34.0.0'

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Flutter doctor & deps
        run: |
          flutter doctor -v
          test -f pubspec.yaml || (echo "Missing pubspec.yaml" && exit 1)
          flutter pub get
          test -f lib/app/main_activity.dart || (echo "Missing lib/app/main_activity.dart" && exit 1)

      - name: Ensure tools + dirs
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p assets/icons assets/splash

      - name: Prepare logo (public URL or placeholder)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${APP_LOGO_URL:-}" ]; then
            echo "APP_LOGO_URL is empty. Using a 1x1 placeholder."
            printf '\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\0\x01\0\0\0\x01\x08\x06\0\0\0\x1f\x15\xc4\x89\0\0\0\x0cIDATx\x9cc```\0\0\0\x04\0\x01\r\n-\xb4\0\0\0\0IEND\xaeB`\x82' > assets/icons/app_icon.png
          else
            curl -fsSL "$APP_LOGO_URL" -o assets/icons/app_icon.png
          fi
          cp assets/icons/app_icon.png assets/splash/splash.png
          dart run flutter_launcher_icons
          dart run flutter_native_splash:create

      - name: Build APK (release)
        run: |
          set -e
          flutter build apk --release \
            -t lib/app/main_activity.dart \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=OWNER_PROJECT_LINK_ID="$OWNER_PROJECT_LINK_ID" \
            --dart-define=OWNER_ATTACH_MODE="$OWNER_ATTACH_MODE" \
            --dart-define=APP_ROLE="$APP_ROLE" \
            --dart-define=WS_PATH="$WS_PATH" \
            --dart-define=PROJECT_ID="$PROJECT_ID" \
            --dart-define=APP_NAME="$APP_NAME" \
            --dart-define=APP_LOGO_URL="$APP_LOGO_URL" \
            --dart-define=SLUG="$SLUG" \
            --dart-define=THEME_ID="${THEME_ID:-}"

      - name: List outputs
        run: ls -R build/app/outputs/flutter-apk || true

      - name: Upload artifact (manual download)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SLUG }}-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
          retention-days: 14

      - name: Create GitHub Release (public link)
        id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-${{ env.SLUG }}-${{ github.run_id }}
          name: "${{ env.APP_NAME }} (run ${{ github.run_id }})"
          files: build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract first APK URL from release
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: app-${{ env.SLUG }}-${{ github.run_id }}
        run: |
          set -euo pipefail
          json="$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")"
          urls="$(echo "$json" | jq -e -r '.assets[]? | select(.name|test("\\.apk$")) | .browser_download_url')"
          first_url="$(echo "$urls" | head -n 1 || true)"
          echo "apk_url=$first_url" >> "$GITHUB_OUTPUT"
          echo "Resolved Release APK: $first_url"

      # ---------------------- PULL MODEL: write manifest in repo ----------------------
      - name: Write manifest (apkUrl/runId/timestamp)
        run: |
          set -e
          mkdir -p builds/${OWNER_ID}/${PROJECT_ID}/${SLUG}
          jq -n \
            --arg url "${{ steps.extract.outputs.apk_url }}" \
            --arg run "${{ github.run_id }}" \
            --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --arg owner "${OWNER_ID}" \
            --arg project "${PROJECT_ID}" \
            --arg linkId "${OWNER_PROJECT_LINK_ID}" \
            --arg slug "${SLUG}" \
            --arg app "${APP_NAME}" \
            '{
              apkUrl: $url,
              runId: $run,
              uploadedAt: $ts,
              ownerId: $owner|tonumber,
              projectId: $project|tonumber,
              ownerProjectLinkId: $linkId,
              slug: $slug,
              appName: $app
            }' \
            > builds/${OWNER_ID}/${PROJECT_ID}/${SLUG}/latest.json
          echo "Wrote builds/${OWNER_ID}/${PROJECT_ID}/${SLUG}/latest.json"

      - name: Commit & push manifest
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.email "ci@users.noreply.github.com"
          git config user.name "CI Bot"
          git add builds/${OWNER_ID}/${PROJECT_ID}/${SLUG}/latest.json
          git commit -m "Update manifest for ${SLUG} (run ${{ github.run_id }})" || echo "No changes to commit"
          git push
