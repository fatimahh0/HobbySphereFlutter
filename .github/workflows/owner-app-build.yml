name: Owner App Build (Android APK)

on:
  repository_dispatch:
    types: [owner_app_build]        # You can trigger with client_payload.CONFIG_URL
  workflow_dispatch:
    inputs:
      CONFIG_URL:
        description: "Absolute URL that returns full app config JSON"
        required: true
        default: ""

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      # Accept CONFIG_URL from dispatch or manual run
      CONFIG_URL: ${{ github.event.client_payload.CONFIG_URL || inputs.CONFIG_URL }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17', cache: 'gradle' }

      - uses: android-actions/setup-android@v3
        with: { api-level: 34, build-tools: '34.0.0' }

      - run: yes | sdkmanager --licenses

      - uses: subosito/flutter-action@v2
        with: { channel: stable, cache: true }

      - run: flutter doctor -v
      - run: flutter pub get
      - run: test -f lib/app/main_activity.dart || (echo "Missing lib/app/main_activity.dart" && exit 1)

      - name: Ensure jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Fetch & validate config (SINGLE source of truth)
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${CONFIG_URL:-}" ] || { echo "CONFIG_URL is required"; exit 1; }

          echo "Fetching config from: $CONFIG_URL"
          json="$(curl -fsS "$CONFIG_URL")" || { echo "Failed to fetch CONFIG_URL"; exit 1; }

          # Extract all fields
          OWNER_ID="$(echo "$json" | jq -er '.ownerId')"
          PROJECT_ID="$(echo "$json" | jq -er '.projectId')"
          OPL="$(echo "$json" | jq -er '.ownerProjectLinkId')"
          SLUG="$(echo "$json" | jq -er '.slug')"
          APP_NAME="$(echo "$json" | jq -er '.appName')"
          APP_LOGO_URL="$(echo "$json" | jq -er '.appLogoUrl')"
          API_BASE_URL="$(echo "$json" | jq -er '.apiBaseUrl')"
          WS_PATH="$(echo "$json" | jq -er '.wsPath')"
          APP_ROLE="$(echo "$json" | jq -er '.appRole')"
          OWNER_ATTACH_MODE="$(echo "$json" | jq -er '.ownerAttachMode')"
          THEME_ID="$(echo "$json" | jq -er '.themeId')"
          CALLBACK_BASE="$(echo "$json" | jq -r '.callbackBase // ""')"
          CALLBACK_TOKEN="$(echo "$json" | jq -r '.callbackToken // ""')"

          # Export to job env
          {
            echo "OWNER_ID=$OWNER_ID"
            echo "PROJECT_ID=$PROJECT_ID"
            echo "OWNER_PROJECT_LINK_ID=$OPL"
            echo "SLUG=$SLUG"
            echo "APP_NAME=$APP_NAME"
            echo "APP_LOGO_URL=$APP_LOGO_URL"
            echo "API_BASE_URL=$API_BASE_URL"
            echo "WS_PATH=$WS_PATH"
            echo "APP_ROLE=$APP_ROLE"
            echo "OWNER_ATTACH_MODE=$OWNER_ATTACH_MODE"
            echo "THEME_ID=$THEME_ID"
            echo "CALLBACK_BASE=$CALLBACK_BASE"
            echo "CALLBACK_TOKEN=$CALLBACK_TOKEN"
          } >> "$GITHUB_ENV"

          echo "Resolved config OK:"
          echo "  owner=$OWNER_ID project=$PROJECT_ID opl=$OPL slug=$SLUG name=$APP_NAME"

      - name: Build APK (release)
        run: |
          set -e
          echo "Building $APP_NAME ($SLUG)â€¦"
          THEME_FLAG="--dart-define=THEME_ID=$THEME_ID"
          flutter build apk --release \
            -t lib/app/main_activity.dart \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=OWNER_PROJECT_LINK_ID="$OWNER_PROJECT_LINK_ID" \
            --dart-define=OWNER_ATTACH_MODE="$OWNER_ATTACH_MODE" \
            --dart-define=APP_ROLE="$APP_ROLE" \
            --dart-define=WS_PATH="$WS_PATH" \
            --dart-define=PROJECT_ID="$PROJECT_ID" \
            --dart-define=APP_NAME="$APP_NAME" \
            --dart-define=APP_LOGO_URL="$APP_LOGO_URL" \
            --dart-define=SLUG="$SLUG" \
            $THEME_FLAG

      - name: List APK outputs
        run: ls -R build/app/outputs/flutter-apk || true

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SLUG }}-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
          retention-days: 14

      - id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-${{ env.SLUG }}-${{ github.run_id }}
          name: "${{ env.APP_NAME }} (run ${{ github.run_id }})"
          files: build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract first APK URL
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: app-${{ env.SLUG }}-${{ github.run_id }}
        run: |
          set -euo pipefail
          json="$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")"
          urls="$(echo "$json" | jq -e -r '.assets[]? | select(.name|test("\\.apk$")) | .browser_download_url')"
          first_url="$(echo "$urls" | head -n 1 || true)"
          echo "apk_url=$first_url" >> "$GITHUB_OUTPUT"
          echo "Resolved APK: $first_url"

      - name: Callback to backend with APK URL (if provided)
        if: ${{ env.CALLBACK_BASE != '' && env.CALLBACK_TOKEN != '' && steps.extract.outputs.apk_url != '' }}
        env:
          APK_URL: ${{ steps.extract.outputs.apk_url }}
        run: |
          set -e
          echo "Calling: ${CALLBACK_BASE}/owner-projects/${OWNER_ID}/${PROJECT_ID}/apps/${SLUG}/apk-url"
          curl -sS -X PUT \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CALLBACK_TOKEN}" \
            -d "{\"apkUrl\":\"${APK_URL}\"}" \
            "${CALLBACK_BASE}/owner-projects/${OWNER_ID}/${PROJECT_ID}/apps/${SLUG}/apk-url" \
            | sed -e 's/.*/[backend] &/'
