name: Owner App Build (Android APK)

on:
  workflow_dispatch: {}   # manual runs only (button)

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: 'gradle'

      - uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: '34.0.0'

      - run: yes | sdkmanager --licenses

      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - run: flutter doctor -v
      - run: flutter pub get
      - run: test -f lib/app/main_activity.dart || (echo "Missing lib/app/main_activity.dart" && exit 1)

      - name: Build APK (release)
        run: |
          set -e
          flutter build apk --release \
            -t lib/app/main_activity.dart \
            --dart-define=API_BASE_URL=http://192.168.1.9:8080 \
            --dart-define=OWNER_PROJECT_LINK_ID=1 \
            --dart-define=OWNER_ATTACH_MODE=header \
            --dart-define=APP_ROLE=both \
            --dart-define=WS_PATH=/api/ws \
            --dart-define=PROJECT_ID=1 \
            --dart-define=APP_NAME="test" \
            --dart-define=APP_LOGO_URL="http://192.168.1.9:8080/uploads/apk/1/1/test_20251106_175330.apk"

      - name: List APK outputs
        run: ls -R build/app/outputs/flutter-apk || true

      - uses: actions/upload-artifact@v4
        with:
          name: test-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error

      - id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-test-${{ github.run_id }}
          name: "Test Owner App (run ${{ github.run_id }})"
          files: build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
