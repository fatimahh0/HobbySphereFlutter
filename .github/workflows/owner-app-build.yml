name: Owner App Build (Android APK)

on:
  repository_dispatch:
    types: [owner_app_build]
  workflow_dispatch:
    inputs:
      BUILD_ID: { description: "Manual build id", required: false }
      OWNER_ID: { required: false }
      PROJECT_ID: { required: false }
      OWNER_PROJECT_LINK_ID: { required: false }
      SLUG: { required: false }
      APP_NAME: { required: false }
      APP_LOGO_URL: { required: false }
      API_BASE_URL: { required: false }
      WS_PATH: { required: false }
      APP_ROLE: { required: false }
      OWNER_ATTACH_MODE: { required: false }
      THEME_ID: { required: false }

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      # Prefer repository_dispatch payload; fallback to workflow_dispatch inputs
      BUILD_ID: ${{ github.event.client_payload.BUILD_ID || inputs.BUILD_ID }}
      OWNER_ID: ${{ github.event.client_payload.OWNER_ID || inputs.OWNER_ID }}
      PROJECT_ID: ${{ github.event.client_payload.PROJECT_ID || inputs.PROJECT_ID }}
      OWNER_PROJECT_LINK_ID: ${{ github.event.client_payload.OWNER_PROJECT_LINK_ID || inputs.OWNER_PROJECT_LINK_ID }}
      SLUG: ${{ github.event.client_payload.SLUG || inputs.SLUG }}
      APP_NAME: ${{ github.event.client_payload.APP_NAME || inputs.APP_NAME }}
      APP_LOGO_URL: ${{ github.event.client_payload.APP_LOGO_URL || inputs.APP_LOGO_URL }}
      API_BASE_URL: ${{ github.event.client_payload.API_BASE_URL || inputs.API_BASE_URL }}
      WS_PATH: ${{ github.event.client_payload.WS_PATH || inputs.WS_PATH }}
      APP_ROLE: ${{ github.event.client_payload.APP_ROLE || inputs.APP_ROLE }}
      OWNER_ATTACH_MODE: ${{ github.event.client_payload.OWNER_ATTACH_MODE || inputs.OWNER_ATTACH_MODE }}
      THEME_ID: ${{ github.event.client_payload.THEME_ID || inputs.THEME_ID }}

    steps:
      - uses: actions/checkout@v4

      - name: Validate required env
        shell: bash
        run: |
          set -euo pipefail
          for v in BUILD_ID OWNER_ID PROJECT_ID SLUG APP_NAME APP_LOGO_URL API_BASE_URL WS_PATH APP_ROLE OWNER_ATTACH_MODE; do
            if [ -z "${!v:-}" ]; then echo "Missing $v"; exit 1; fi
          done
          echo "OK: payload present"

      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17', cache: 'gradle' }

      - uses: android-actions/setup-android@v3
        with: { api-level: 34, build-tools: '34.0.0' }

      - run: yes | sdkmanager --licenses

      - uses: subosito/flutter-action@v2
        with: { channel: stable, cache: true }

      - run: flutter doctor -v
      - run: flutter pub get
      - run: test -f lib/app/main_activity.dart || (echo "Missing lib/app/main_activity.dart" && exit 1)

      - name: Prepare assets
        run: |
          set -e
          mkdir -p assets/icons assets/splash
          curl -fsSL "$APP_LOGO_URL" -o assets/icons/app_icon.png
          cp assets/icons/app_icon.png assets/splash/splash.png
          dart run flutter_launcher_icons
          dart run flutter_native_splash:create

      - name: Build APK (release)
        run: |
          set -e
          flutter build apk --release \
            -t lib/app/main_activity.dart \
            --dart-define=API_BASE_URL="$API_BASE_URL" \
            --dart-define=OWNER_PROJECT_LINK_ID="$OWNER_PROJECT_LINK_ID" \
            --dart-define=OWNER_ATTACH_MODE="$OWNER_ATTACH_MODE" \
            --dart-define=APP_ROLE="$APP_ROLE" \
            --dart-define=WS_PATH="$WS_PATH" \
            --dart-define=PROJECT_ID="$PROJECT_ID" \
            --dart-define=APP_NAME="$APP_NAME" \
            --dart-define=APP_LOGO_URL="$APP_LOGO_URL" \
            --dart-define=SLUG="$SLUG" \
            --dart-define=THEME_ID="$THEME_ID"

      - name: List outputs
        run: ls -R build/app/outputs/flutter-apk || true

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.SLUG }}-apk
          path: build/app/outputs/flutter-apk/*.apk
          if-no-files-found: error
          retention-days: 14

      - id: rel
        uses: softprops/action-gh-release@v2
        with:
          tag_name: app-${{ env.SLUG }}-${{ env.BUILD_ID }}
          name: "${{ env.APP_NAME }} (build ${{ env.BUILD_ID }})"
          files: build/app/outputs/flutter-apk/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract first APK URL
        id: extract
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TAG: app-${{ env.SLUG }}-${{ env.BUILD_ID }}
        run: |
          set -euo pipefail
          json="$(curl -sS -H "Authorization: Bearer $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REPO}/releases/tags/${TAG}")"
          urls="$(echo "$json" | jq -e -r '.assets[]? | select(.name|test("\\.apk$")) | .browser_download_url')"
          first_url="$(echo "$urls" | head -n 1 || true)"
          echo "apk_url=$first_url" >> "$GITHUB_OUTPUT"
          echo "Resolved APK: $first_url"

      - name: Publish build manifest (JSON inside repo)
        if: ${{ steps.extract.outputs.apk_url != '' }}
        run: |
          set -e
          mkdir -p builds
          cat > "builds/${BUILD_ID}.json" <<EOF
          {
            "buildId": "${BUILD_ID}",
            "ownerId": ${OWNER_ID},
            "projectId": ${PROJECT_ID},
            "slug": "${SLUG}",
            "appName": "${APP_NAME}",
            "apkUrl": "${{ steps.extract.outputs.apk_url }}"
          }
          EOF

          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add "builds/${BUILD_ID}.json"
          git commit -m "build manifest ${BUILD_ID}"
          git push

      - name: Echo manifest URL
        run: |
          echo "Manifest: https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/builds/${BUILD_ID}.json"
